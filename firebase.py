from firebase_admin import firestore
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
import ast

import firebase_admin
from firebase_admin import credentials
# user_query_embeddings = [0.0007654212, -0.022078427, 0.030095253, -0.021006659, -0.01029612, 0.03283898, -0.032467432, -0.021764042, -0.0024150512, -0.030638283, 0.021878364, -0.008488405, 0.008638453, -0.017462678, 0.005019448, 0.008102568, 0.020720854, -0.010410443, -0.0164052, -0.012361061, -0.032896142, -0.00146475, 0.02872339, -0.00067923317, -0.02459351, 0.00014814964, 0.031267054, -0.023821836, 0.011918063, -0.021806912, 0.030838346, -0.006051918, -0.018934572, 0.006662826, -0.023678934, -0.0016844625, 0.014904724, 0.0084169535, 0.012675446, -0.01756271, 0.005383849, 0.00014759142, -0.0036011415, -0.017176872, -0.016876778, 0.021506816, -0.009774527, -0.021349624, -0.01879167, 0.0060161925, 0.009467286, 0.0149761755, -0.048701152, 0.0019416868, -0.005744678, 0.026065405, -0.013332797, 0.019763406, 0.023564612, -0.0009199344, 0.007573829, 0.024150511, -0.0139615685, -0.01709113, -0.011153535, -0.011282148, 0.00789536, -0.006719987, -0.0034868196, -0.019777697, 0.030409638, 0.036039993, -0.0113250185, -0.0021667583, 0.028366134, -0.016590973, -0.017762773, -0.0028884155, 0.027808815, -0.0019845576, 0.0026061833, -0.005508889, 0.00732375, 0.008574146, 0.0008471435, -0.0003992337, 0.0044478383, -0.0066449633, -0.007566684, 0.018991735, 0.019620504, -0.01233248, 0.017434098, 0.025508085, -0.010860586, 0.0025061516, -0.0053802766, 0.02406477, 0.023893287, -0.0092314975, -0.0080096815, 0.0077738925, -0.027337236, -0.0065056337, -0.035496965, -0.029952351, -0.01756271, 0.0054874537, 0.016019363, -0.025665278, -0.021306753, 0.011882338, -0.0024882888, -0.013575732, 0.00016645901, -0.030038092, -0.013311362, 0.0025650987, -0.017791353, -0.017248325, 0.017962836, 0.004001268, 0.044471238, -0.017234035, -0.013389958, -0.010081767, -0.0060340553, -0.005344551, 0.0011164253, -0.020163534, 0.031838663, 0.025279442, -0.012060965, -0.03446807, 0.006387739, 0.0029402177, 0.00093511783, -0.023850417, -0.011982369, -0.0068807523, 0.01203953, 0.02632263, 0.010474749, -0.007502378, -0.016962519, 0.01114639, -0.004622894, 0.026294049, -0.0043263715, 0.004944424, -0.012353916, -0.009345819, -0.023807546, -0.0031242045, 0.0022239191, 0.01641949, 0.011710855, 0.0251937, -0.00051802135, -0.030809766, 0.007795328, 0.009045725, -0.01403302, -0.0062805624, 0.0069557764, 0.03278182, 0.029252129, -0.012432512, -0.006730705, 0.00659852, 0.0029027057, 0.017691322, -0.0073809107, 0.03766908, 0.0017702039, 0.014011584, 0.017791353, 0.003025959, 0.018920282, -0.021506816, 0.03115273, 0.026608434, 0.004329944, 0.017748483, -0.021792622, -0.009452996, 0.0067342776, -0.008531275, 0.02815178, -0.00440854, -0.004558588, 0.021506816, -0.039469652, 0.004133453, -0.59447414, -0.020277856, 0.0007381804, -0.028780552, 0.023707515, 0.008488405, -0.016905358, 0.016162265, -0.036039993, 0.0025132967, 0.0018202198, 0.010238959, -0.010689102, -0.020978078, 0.019606214, -0.011224986, 0.01319704, -0.01319704, -0.0020988795, -0.016848197, -0.018348673, 0.0134185385, -0.009981736, 0.024379157, 0.006780721, -0.019077476, 0.00689147, -0.024979346, 0.006973639, 0.004376387, -0.022135587, 0.025322312, 0.019677665, 0.00015719268, 0.04395679, -0.0028544762, -0.045214333, -0.0040084133, -0.016276587, 0.04644329, -0.02693711, -0.023007292, 0.037268955, 0.013804375, -0.020878047, 0.012675446, 0.018705929, -0.008745629, -0.019191798, -0.019248959, -0.011267858, 0.006241264, 0.011918063, 0.00070513424, 0.026565563, -0.020992368, 0.04292789, 0.01521911, 0.0052516647, 0.012882655, 0.015033336, 0.014833273, -0.02872339, -0.024207672, -0.0048551103, 0.009867413, 0.00013508747, -0.0046514743, -0.017376937, 0.013918698, 0.012361061, -0.0023453862, 0.0052123666, -0.0035368353, 0.006998647, 0.026651304, 0.0020988795, -0.018948862, -0.011610823, 0.0066092378, 0.0056767995, -0.017376937, -0.0304668, -0.009831687, 0.008902822, 0.035982832, -0.035611287, -0.036525864, -0.024965055, -0.004376387, 0.022192748, 0.023150194, -0.03221021, -0.05553189, 0.00050730363, 0.0010994556, 0.014211647, 0.0029955923, 0.014747531, 0.0016585614, -0.018477285, -0.027080012, -0.023350257, 0.000595278, 0.068421684, -0.013275636, -0.027380107, 0.005012303, 0.035382643, -0.00062251877, -0.007580974, 0.017705612, -0.020392178, 0.020949498, 0.012346771, -0.036583025, 0.0056303563, -0.0005090899, -0.0119323535, -0.003904809, 0.037897725, 0.013654328, 0.022221329, -0.015690688, -0.0060233376, 0.025065087, 0.010217524, -0.023707515, 0.021892654, -0.009874558, -0.013361378, -0.029080646, -0.0045550154, -0.009645915, 0.043670986, 0.007345185, 0.016290877, 0.0052766725, -0.0072522988, -0.0050265933, 0.010846295, 0.0026401225, 0.007280879, -0.036783088, -0.0066449633, 0.0043013636, -0.022464262, 0.022064136, 0.016105104, 0.00018912244, -0.0052302293, -0.0033153365, -0.00248293, 0.013947278, -0.016576683, -0.008481259, 0.022192748, -0.04104158, -0.0034350173, -0.02992377, -0.0114607755, 0.039155267, -0.03972688, 0.0006068888, -0.019020315, 0.01142505, 0.0022828665, 0.027508719, -0.009824542, -0.011475066, -0.016233716, -0.015562075, 0.006484198, 0.008502695, 0.0051230523, -0.012232449, -0.013740069, -0.018677348, -0.0040084133, 0.019006025, 0.0158193, 0.013932988, 0.013604312, 0.007298742, 0.041241642, 0.030609703, 0.010396153, 0.0013129162, -0.052559517, 0.0061948206, -0.03755476, 0.02052079, 0.0061555225, 0.029666547, 0.006770003, -0.021263883, 0.0009279727, 0.029809449, 0.021192431, 0.01318275, 0.0057482505, 0.014633209, 0.029080646, 0.007888215, 0.00051221595, -0.014483162, -0.015733559, -0.011710855, 0.023064453, 0.029109227, 0.0033171228, -0.025636697, 0.012868364, -0.03692599, 0.00440854, 0.008838516, -0.015061917, 0.020663692, -0.0073023145, 0.022521425, 0.0026008245, -0.014533178, 0.034696713, -0.0073023145, -0.026851367, 0.0044228304, 0.0004974791, 0.008474114, 0.007888215, -0.02236423, -0.021821203, -0.005641074, -0.008402663, 0.009110031, 0.049015537, 0.0006921837, 0.013354233, 0.0029723707, 0.0045478703, 0.0037083183, 0.04207048, 0.0036797377, 0.032010145, -0.018591607, 0.0028169644, 0.020392178, 0.033810716, 0.023907578, -0.010367572, -0.0205065, 0.008702759, -0.00042334848, 0.014125906, -0.0012075256, 0.015562075, -0.007095106, -0.018062867, 0.0124039315, 0.025007926, 0.025979662, 0.0042084767, 0.026436951, 0.030409638, -0.01754842, 0.006241264, -0.02227849, -0.010396153, -0.0053266883, 0.0012825493, -0.01932041, -0.0138258105, -0.016133685, 0.005083754, -0.028623357, -0.0052302293, 0.0037547615, 0.013368523, -0.0066020926, -0.00818831, 0.029152097, -0.0063913115, -0.011853757, 0.042556345, -0.005516034, 0.018320093, -0.005469591, -0.019449022, 0.00906716, -0.0053088255, 0.025050797, 0.020949498, 0.021764042, 0.013318507, -0.031352796, -0.027765945, 0.016133685, 0.029809449, -0.017262615, 0.041898996, -0.014818983, 0.013890117, -0.01939186, -0.014861854, -0.0067664306, 0.034868196, -0.00081543706, -0.031952985, -0.024936475, 0.011589387, -0.02513654, -0.037326116, -0.036411542, -0.011275003, 0.01376865, 0.0051766406, 0.00075872266, 0.002847331, -0.025408054, 0.03924101, 0.016305167, 0.006248409, -0.043013632, -0.009953155, 0.007795328, 0.03415368, 0.021592557, 0.007745312, 0.029037775, -0.019491892, 0.0012468238, 0.004433548, -0.015662108, 0.008402663, 0.0070415176, -0.007266589, 0.016962519, 0.03878372, -0.009781672, 0.0151762385, 0.021978395, 0.012439657, -0.041784674, -0.04284215, -0.015619236, -0.014140196, -0.009495867, 0.01754842, 0.03869798, 0.044757042, 0.036440123, 0.011089229, 0.0018577317, 0.0047586514, -0.025093667, -0.023578903, 0.0054553007, 0.0075523937, 0.017905675, -0.003547553, 0.036725927, -0.016762456, 0.018462995, 0.00329926, -0.0045943134, -0.0011226772, 0.020963788, -0.00020140312, -0.013175605, 0.011367889, 0.002184621, -0.0068807523, 0.04449982, -0.0047657965, -0.00019291829, 0.016776746, -0.009281513, -0.03275324, -0.0087885, 0.008731339, 0.0047122077, -0.013004122, -0.0097030755, 0.0029759433, -0.04281357, -0.041270223, -0.0007743526, -0.010403298, -0.00732375, -0.0072773066, -0.010439023, -0.0432137, 0.0006573512, -0.02337884, -0.009745946, -0.01879167, -0.027494429, -0.030581122, 0.011746581, 0.017505549, 0.008959983, 0.018977445, 0.008252616, -0.005712525, -0.0059340238, -0.017219745, -0.014154486, -0.0004570645, -0.029980931, -0.041355964, 0.008959983, -0.0023900433, 0.0012146707, -0.026508402, 0.0013075573, 0.0036868828, 0.023607483, 0.03509684, -0.03752618, 0.023621773, 0.010396153, 0.027865976, 0.022535715, 0.011910918, -0.02224991, -0.0041548884, -0.023564612, 0.0092958035, -0.0056160656, 0.012182433, 0.008431244, 0.004262065, -0.02236423, -0.004694345, -0.03406794, 0.0036654475, -0.0132184755, -0.016019363, -0.020978078, 0.012804058, 0.0027347954, 0.01053191, 0.0086241625, -0.00903858, 0.059904702, 0.01587646, -0.034982517, 0.026794206, -0.01201095, -0.015090497, 0.016905358, 0.015047627, -0.0109891975, -0.0015996142, 0.0027848112, 0.009481577, -0.0006756606, -0.012954106, 0.0011548303, -0.03395362, -0.010660522, 0.018620187, 0.015947912, -0.018448705, -0.03175292, -0.01929183, -0.00482653, -0.0072522988, -0.012654011, -0.011875193, -0.022607166, -0.009617334, 0.013532861, 0.023850417, 0.025065087, 0.008252616, -0.020134954, -0.032610334, -0.018620187, -0.011846612, -0.037411857, 0.02053508, -0.010088912, 0.033553492, 0.027037142, 0.018520156, 0.018920282, 0.014483162, 0.013068428, -0.0051230523, -0.028494745, -0.0018488003, 0.009645915, -0.008438389, 0.013518571, 0.03175292, -0.011889483, 0.0007698869, 0.0125396885, 0.016605264, 0.02689424, -0.015590656, -0.02583676, -0.04644329, -0.047929477, 0.0072630164, 0.0026615579, -0.005916161, 0.01876309, -0.021978395, -0.014861854, 0.023693224, 0.0145045975, 0.039469652, -0.00853842, 0.0467291, -0.0069557764, 0.00558034, -0.014161631, 0.009745946, -0.011832322, -0.010031751, -0.0016139044, 0.002197125, 0.028880583, 0.0055696224, 0.016933938, 0.011046358, 0.0036868828, -0.008974273, 0.013189895, -0.017462678, -0.013025558, 0.00733804, -0.008781355, -0.014590339, -0.02815178, -0.02632263, -0.007202283, 0.005265955, -0.005994757, -0.0012262815, 0.015433463, -0.015419173, -0.0040155584, 0.013097009, 0.0069950745, 0.020220695, 0.011210696, 0.015733559, 0.0012432513, 0.00658423, -0.0073666205, -0.00793823, -0.025493795, -0.009002853, 0.0016701722, 0.034353744, 0.0072773066, -0.022421392, -0.0054410105, -0.024321996, -0.008238326, -0.03586851, 0.009874558, -0.034811035, -0.0015960416, -0.0054945988, -0.0087885, -0.017505549, 0.019506183, 0.010439023, 0.0032438852, 0.019163217, -0.0051909313, -0.0164052, 0.0048229573, -0.037268955, 0.030552542, -0.0062948526, 0.00482653, -0.014140196, -0.0019399006, -0.04561446, 0.002827682, 0.005183786, 0.016019363, 0.009988881, -0.011232131, 0.02580818, 0.014833273, 0.0028008877, -0.015547785, -0.013540006, 0.029409321, -0.018877411, -0.018591607, -0.0067985835, -0.0026204735, -0.0040977276, -0.015333432, -0.010274685, -0.012732607, -0.014526033, -0.01469037, 0.041984737, 0.005680372, -0.012439657, -0.018205771, -0.011875193, 0.008324067, -0.0018184335, 0.008288342, 0.011818032, -0.0010565849, 0.011846612, 0.0097673815, -0.03175292, 0.030638283, 0.016676715, 0.021406785, -0.008245471, 0.016233716, -0.01812003, 0.019791987, 0.040841516, -0.009438706, -0.03341059, -0.006937913, -0.012725462, -0.014440292, 0.007502378, 0.0033474895, -0.040784355, -0.018019997, 0.0005242733, -0.015319142, 0.004622894, 0.0017710971, -0.01233248, 0.03624006, 0.01580501, -0.0363258, 0.005419575, -0.010967762, 0.004990868, 0.0066342456, 0.028366134, -0.012418222, -0.0046800547, -0.0063448683, -0.00057920144, -9.919439e-05, -0.0020345734, -0.0072558713, 0.009988881, 0.010260395, -0.018991735, -0.00613766, 0.009574464, -0.016005073, -0.017834224, 0.009260078, 0.014383131, 3.8125923e-05, 0.0069093327, 0.008709904, 0.016305167, 0.011403615, -0.020706562, -0.04455698, -0.04984437, -0.026265468, -0.031838663, -0.006466335, -0.00903858, 0.025093667, 0.0146475, -0.04407111, -0.016691005, -0.024965055, -0.05556047, -0.035554126, -0.02866623, -0.0010297907, 0.028237522, 0.020677982, 0.00570538, 0.030895507, -0.0029187822, 0.019563343, 0.004558588, 0.011603678, -0.007559539, 0.0034886058, 0.003840503, -0.025279442, -0.041841835, 0.0025007927, 0.023836127, 0.02642266, -0.0046514743, 0.0044549834, 0.018663058, 0.0013129162, 0.0081454385, 0.0026079696, 0.008967128, 0.0028080328, 0.015690688, -0.049358502, 0.0020524363, 0.021878364, 0.008095423, -0.02639408, 0.0024025473, 0.015019046, -0.017319776, -0.013983004, -0.00042267863, -0.0050980444, 0.006998647, -0.029123517, 0.025022216, -0.0011325019, 0.0067592855, 0.030809766, -0.014025874, -0.024207672, -0.0090957405, 0.02103524, -0.022164168, 0.009753091, 0.026879948, -0.025308022, -0.01813432, 0.025365183, -0.019777697, -0.008316922, -0.022721488, -0.001808609, 0.013304217, 0.0010458672, 0.0027562308, 0.020263566, -0.0016174769, -0.005744678, 0.011710855, -0.028852003, -0.0012959465, -0.009088595, 0.013904408, -0.01201095, -0.004655047, -0.012411077, -0.023350257, -0.034210842, -0.0038262128, 0.019020315, 0.035468385, 0.039040945, 0.20532222, 0.015290561, -0.03409652, 0.0328104, 0.0036940281, 0.0068057287, 0.0316386, 0.019949181, -0.010317556, 0.012789768, -0.0062591266, 0.016733875, -0.009467286, 0.0015424532, -0.009838833, -0.023793256, -0.035296902, -0.0085527105, 0.00010427412, 0.0146475, 0.012218159, 0.0052445196, -0.005183786, -0.019563343, 0.030009512, -0.021878364, 0.002388257, 0.029980931, 0.019549053, 0.0339822, -0.0021256737, 0.024950765, 0.012246739, -0.0011682274, -0.027337236, -0.01083915, 0.036097154, -0.019506183, 0.020949498, 0.021792622, 0.023736095, -0.016147975, -0.007988246, -0.003458239, -0.03103841, -0.018448705, -0.015304851, -0.012675446, 0.005655364, 0.03115273, -0.015905041, -0.0008842088, 0.021849783, 0.033667814, -0.007452362, 0.00602691, 0.026822787, 0.010496184, -0.013818665, 0.015390593, 0.009102886, 0.018462995, 0.0069093327, 0.0062055383, -0.00054034987, -0.0054481556, -0.01814861, -0.015733559, 0.0146475, 0.013532861, -0.004190614, -0.009845978, 0.016919648, 0.022707198, -0.034639552, -0.017419808, 0.009467286, 0.013890117, 0.022049846, 0.03972688, 0.0042013316, -0.028266102, 0.004465701, -0.012861219, -0.00484082, -0.03221021, 0.014518888, 0.006898615, -0.028780552, 0.0028098193, 0.00074934465, 0.0049765776, -0.012589705, -0.020620821, 0.013868681, 0.0029509354, -0.011639403, 0.014447437, -0.0024472042, -0.0052052215, -0.02816607, 0.029266419, 0.019206088, -0.0036940281, 0.0037797694, 0.0042656376, -0.024207672, 0.0015076207, 0.005923306, -0.007070098, -0.009338674, -0.038297854, 0.00941727, -0.0044371206, -0.003969115, 0.017476968, -0.010153218, -0.012211014, 0.006144805, -0.0035993552, 0.018262932, -0.038840882, 0.004755079, -0.0036457984, -0.013139879, -0.0053231157, -0.0339822, 0.009996026, -0.021778332, -0.04458556, 0.01583359, -0.0012200295, -0.013361378, -0.027994588, 0.0018005708, 0.0051802136, -0.011818032, -0.02938074, 0.001560316, 0.021506816, 0.0030509671, 0.032896142, -0.009953155, -0.009617334, 0.020792305, -0.015619236, 0.027765945, 0.009803107, -0.011153535, -0.04735787, 0.0003079101, -0.006112652, -0.015404883, 0.010360427, 0.022392811, -0.006694979, -0.012575415, -0.040155586, 0.015362012, 0.002465067, -0.020735145, -0.0038190677, 0.022507135, -0.011825177, -0.014183067, 0.013611457, -0.18302944, -0.0019845576, 0.038983785, -0.016519522, 0.010739118, 0.017948546, 0.00790965, 0.015133368, -0.045500137, -0.0051051895, 0.013275636, 0.008924257, -0.036497284, -0.006577085, -0.028037459, 0.010953472, 0.008338357, -0.0007073671, 0.00484082, 0.01697681, 0.031209892, -0.01873451, 0.01631946, 0.0047729416, 0.006309143, -0.020206405, -0.018663058, 0.011074939, 0.011110664, 2.1519098e-05, -0.013354233, 0.00717013, 0.031409957, 0.0009940651, -0.008452679, -0.0028437586, -0.017176872, 0.0046264664, -0.008988563, 0.025493795, 0.02107811, 0.020306436, 0.0014442077, 0.017276905, -0.00035234384, 0.014383131, -0.004165606, -0.018663058, 0.014790403, -0.010003171, 0.01636233, -0.0038547933, -0.01586217, 0.011210696, 0.0023489587, 0.0010789135, 0.022964422, 0.0328104, -0.022650037, -0.0480438, -0.006834309, 0.0014433146, 0.02642266, -0.023107324, -0.009724511, -0.0006622635, -0.0030348906, 0.027022852, -0.020292146, 0.004362097, 0.006623528, -0.010367572, -0.014404566, 0.005312398, 0.025079377, -0.003936962, -0.026622724, 0.020020632, 0.010010316, -0.0036654475, 0.00016110016, 0.033124786, -0.00903858, 0.040098425, -0.01634804, 0.023721805, -0.016819617, -0.021263883, -0.024965055, 0.0047800867, 0.03509684, -0.035954252, -0.019220378, -0.01634804, 0.011753726, 0.006841454, 0.0068128738, -0.0024025473, 0.005851855, 0.012132417, 0.0076952963, 0.0119323535, -0.047672253, 0.014418856, 0.010681957, 0.04512859, 0.00083463953, 0.01932041, 0.044271175, -0.007495233, -0.011389324, 0.013511426, 0.0042084767, 0.013482845, 0.023135904, 0.016776746, 0.0087885, 0.0042334846, 0.008767065, 0.017819934, 0.0020042066, -0.009724511, -0.008209745, -0.011603678, 0.019006025, -0.017648451, -0.11655123, -0.004930134, -0.005633929, 0.009495867, -0.005783976, -0.0047729416, -0.035639867, -0.010596216, -0.03635438, 0.008767065, 0.0041405982, -0.00030835666, 0.010660522, 0.004865828, 0.01316846, -0.012632576, -0.006687834, 0.013790085, 0.010932037, 0.024250545, 0.006209111, -0.016662424, 0.017991416, -0.0018666631, -0.0104461685, 0.008988563, -0.02989519, 0.019649085, 0.020349307, 0.0049086986, 0.0122038685, -0.023964738, -0.0019720537, 0.005165923, -0.016090814, -0.012511108, -0.012189578, -0.003783342, 0.028437585, 9.623586e-05, 0.0128112035, -0.015061917, 0.008131148, -0.0028008877, -0.026994271, -0.0047586514, -0.0040905825, 0.025993953, -0.0031259907, -0.02642266, -0.023621773, 0.004998013, -0.046014585, 0.015704978, 0.020392178, -0.028537616, 0.024693541, 0.023907578, -0.014390276, 0.0067521404, -0.014004439, -0.00790965, -0.03698315, 0.043670986, 0.015261981, 0.0009386904, 0.0033796427, 0.008102568, -0.016791036, -0.0007430927, -0.0071987105, 0.009338674, -0.015033336, 0.01376865, -0.042327702, 0.008938547, -0.032067306, -0.016076524, 0.010753408, -0.006491343, -0.0127468975, -0.021864073, 0.0015692473, -0.023707515, 0.03621148, -0.020849466, -0.0055053164, -0.0112607125, 0.0039905505, -0.0411559, -0.0023489587, -0.005541042, 0.051787842, 0.0012602209, -0.017348357, -0.025007926, -0.015033336, 0.0029080645, -0.0169911, -0.02868052, -0.03858366, 0.0015522777, -0.0517021, 0.029752288, 0.007559539, -0.008931402, 0.011789451, -0.007516668, 0.0012566483, -0.013482845, -0.013032703, 0.0034100094, -0.024922185, 0.026879948, -0.0050587463, -0.010031751, -0.02224991, -0.003272466, 0.015962202, 0.006937913, 0.016748166, -0.007752457, -0.0036190043, -0.028280392, 0.011875193, 0.009724511, 0.0033403444, 0.02457922, -2.5998754e-05, 0.0074023465, -0.013868681, -0.027794525, -0.008316922, -0.03223879, -0.022006975, 0.036697347, -0.00027553376, 0.0043906774, 0.006820019, 0.030895507, 0.019163217, 0.014947595, 0.010167508, -0.012475383, 0.0030223865, -0.008909967, 0.010167508, 0.0088885315, -0.0006064422, 0.002465067, 0.017191164, 0.0130827185, 0.0092958035, 0.010674812, -0.010539055, 0.0074666524, -0.018891701, -0.04164177, 0.003908382, 0.0039512524, 0.021864073, -0.0021506818, 0.032095887, -0.014111616, 0.01760558, -0.020177824, 0.008474114, 0.0044549834, 0.012246739, 0.006191248, 0.0142330825, -0.064992025, 0.00063278986, -0.024679251, -0.011203551, -0.0036011415, -0.007959666, 0.007952521, -0.008102568, 0.0014852922, -0.018348673, 0.042527765, -0.0029973786, -0.0138258105, -0.012839784, 0.034353744, 0.028894873, -0.009967445, 0.0016701722, 0.0025186555, 0.014876144, 0.009110031, -0.03152428, -0.0046907724, 0.003502896, 0.006341296, 0.017391227, 0.0071844202, 0.00792394, -0.009460141, 0.016691005, 0.0145045975, -0.0012307472, 0.0070272274, -0.012110981, -0.005233802, -0.016519522, 0.0025686712, 0.0038762286, -0.04044139, -0.010774843, 0.020920917, -0.013075573, 0.00020865988, 0.016676715, 0.0002587874, 0.0035064686, 0.02989519, -0.00789536, -0.016833907, -0.04295647, 0.011860902, 0.0026954971, -0.0067735757, -0.012825494, -0.010681957, 0.026136857, 0.00991743, 0.0025204418, 0.00788107, 0.01083915, -0.0023418136, 0.013061283, -0.019549053, -0.01761987, -0.022607166, -0.02104953, -0.01141076, 0.029466482, 0.008195455, -0.015319142, 0.092372134, 0.010953472, -0.003915527, 0.009831687, -0.0004570645, 0.024264835, 0.035611287, 0.0032546031, 0.008945692, -0.036725927, 0.0152476905, 0.019248959, -0.019606214, -0.010624796, 0.0021435365, 0.01706255, 0.014011584, 0.023050163, 0.002586534, -0.018448705, 0.019763406, 0.021992685, 0.0018032502, -0.0015469189, -0.023621773, -0.0014156273, 0.035697028, 0.010617651, 0.002949149, -0.026622724, 0.0047229254, 0.0018452277, -0.011067794, -0.001700539, 0.00938869, 0.01469037, -0.007580974, 0.007866779, 0.0028884155, 0.000974416, 0.0076167, -0.005208794, -0.015161948, -0.018877411, 0.0020274282, -0.015419173, 0.0020810168, -0.027294366, -0.01633375]
# cred = credentials.Certificate("vcs-hackon-firebase.json")
# firebase_admin.initialize_app(cred)


def convert_to_list(embeddings):
    result = []
    for embedding in embeddings:
        result.append(ast.literal_eval(embedding))
    return result


# This function is used to get all the previous queries of the current session.

def get_all_embeddings(category, doc_ref):
    embedding_list = []
    if doc_ref.get().exists:
        embedding_list = doc_ref.get().to_dict()[category]['embeddings']
    else:
        print("Document does not exist")
    embedding_list = convert_to_list(embedding_list)
    return embedding_list


# This function finds the top K results by matching all the previous query of session with current query

def find_top_similar_vectors(query_vector, other_vectors, top_n=3):
    # Convert vectors to numpy arrays if not already
    query_vector = np.array(query_vector).reshape(1, -1)  # Reshape to row vector
    other_vectors = np.array(other_vectors)

    # Compute cosine similarities
    similarities = cosine_similarity(query_vector, other_vectors)

    # Get indices of top n similar vectors (excluding the query vector itself)
    top_indices = similarities.argsort()[0][-top_n:][::-1]

    # Return the top n similar vectors, their cosine similarities, and their original indices
    top_vectors = other_vectors[top_indices]
    top_similarities = similarities[0][top_indices]

    return top_vectors, top_similarities, top_indices


# Function to append data to an array field in Firestore

def update_query_document(doc_ref, field_path, new_data):
    try:
        field_initial = field_path.split(".")[0]
        field_second = field_path.split(".")[1]
        updated_data = []
        if doc_ref.get().exists:
            l1 = doc_ref.get().to_dict()[field_initial][field_second]
            if l1 is not None:
                updated_data += l1
                updated_data.append(new_data)
            doc_ref.update({field_path: updated_data})
        else:
            print("Document does not exist")
    except Exception as e:
        print(f"Error in updating query document on firestore: {e}")


# Update the session with the new query, response, sentiment, and embedding

def update_session(uid, category, new_embedding, new_query, new_response, new_sentiment):
    try:
        db = firestore.client()
        doc_ref = db.collection("Queries").document(uid)
        update_query_document(doc_ref, f"{category}.embeddings", str(new_embedding))
        update_query_document(doc_ref, f"{category}.queries", new_query)
        update_query_document(doc_ref, f"{category}.responses", new_response)
        update_query_document(doc_ref, f"{category}.sentiments", new_sentiment)

    except Exception as e:
        print(f"Error in updating session on firestore: {e}")


def read_query_document(doc_ref, category, path, index_values):
    try:
        query_index_result = []
        if doc_ref.get().exists:
            l1 = doc_ref.get().to_dict()[category][path]
            for index in index_values:
                query_index_result.append(l1[index])
        else:
            print("Document does not exist")

        return query_index_result
    except Exception as e:
        print(f"Error in reading query document on firestore: {e}")


def pooling_query_data(user_query_embeddings, previous_query_embeddings):
    # Convert to numpy arrays if not already
    user_query_embeddings = np.array(user_query_embeddings)
    previous_query_embeddings = np.array(previous_query_embeddings)

    # Compute the column-wise average of previous_query_embeddings
    previous_embeddings_average = np.mean(previous_query_embeddings, axis=0)

    # Compute the weighted average with user_query_embeddings
    pooling_embeddings = (5 * user_query_embeddings + previous_embeddings_average) / 6
    print("Pooling embeddings:", pooling_embeddings)

    return pooling_embeddings


def get_previous_query_data(uid, category, user_query_vector):
    try:
        # Create object of firestore
        db = firestore.client()
        doc_ref = db.collection("Queries").document(uid)

        # Get all previous embeddings of the targeted category
        previous_embeddings = get_all_embeddings(category=category, doc_ref=doc_ref)

        # Find the top similar vectors
        top_vectors, top_similarities, top_indices = find_top_similar_vectors(query_vector=user_query_vector,other_vectors=previous_embeddings, top_n=3)

        print(top_similarities)
        print(top_indices)

        # Get the previous queries, responses, and sentiments
        previous_similar_queries = read_query_document(doc_ref=doc_ref, category=category, path="queries",
                                                       index_values=top_indices)
        previous_similar_response = read_query_document(doc_ref=doc_ref, category=category, path="responses",
                                                        index_values=top_indices)
        previous_similar_sentiments = read_query_document(doc_ref=doc_ref, category=category, path="sentiments",
                                                          index_values=top_indices)

        # Pool the user query embeddings with the top similar vectors
        embeddings_query_and_previous = pooling_query_data(user_query_vector, top_vectors)

        return previous_similar_queries, previous_similar_response, previous_similar_sentiments, embeddings_query_and_previous
    except Exception as e:
        print('Error in get_previous_query_data:', e)
        return [], [], [], user_query_vector

# get_previous_query_data(uid="oGjjFFZj0IuCpSZmOT1Y", category=1, user_query_vector=user_query_embeddings)
# update_session(uid="oGjjFFZj0IuCpSZmOT1Y", category=1, new_embedding = [1, 3, 2, 4, 5, 4, 3,5], new_query="how can i achieve scaling in EC2 in aws?", new_response="Sorry, can you please repeat that?", new_sentiment="Frustrated")
